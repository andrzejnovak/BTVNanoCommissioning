stages:
    - proxy
    - run

voms_proxy:
    stage: proxy
    image: gitlab-registry.cern.ch/clange/grid-proxy-test:master
    artifacts:
        paths:
            - proxy
    script:
        - mkdir -p ${HOME}/.globus
        - printf "${GRID_USERCERT}" | base64 -d > ${HOME}/.globus/usercert.pem
        - printf "${GRID_USERKEY}" | base64 -d > ${HOME}/.globus/userkey.pem
        - chmod 400 ${HOME}/.globus/userkey.pem
        - printf "${GRID_PASSWORD}" | base64 -d | voms-proxy-init --voms cms --pwstdin
        - voms-proxy-info --all
        - export VOMSPROXY=$(voms-proxy-info -path)
        - mkdir proxy
        - cp ${VOMSPROXY} proxy/x509_proxy

runcode:
    dependencies:
        - voms_proxy
    stage: run
    tags:
        - cvmfs
    image: coffeateam/coffea-base:latest
    script:
        - export X509_USER_PROXY=${PWD}/proxy/x509_proxy
        - python runner.py --workflow fattag --executor futures --samples datasets/datasets_btag2017.json --output hists_fattag_flavor_mutag_2017.coffea7 --year 2017 --limit 2 
    artifacts:
        paths:
            - histograms 


